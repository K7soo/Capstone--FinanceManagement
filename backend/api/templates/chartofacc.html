{% extends 'base.html' %} {% load static %} {% block title %} Chart of Accounts
{% endblock %} {% block extra_css %}
<link rel="stylesheet" href="{% static 'css/chartofacc.css' %}" />
{% endblock %} {% block content %}
<h1 class="title">Chart of Accounts</h1>
<p>Setup page of charting ledger accounts.</p>

<div class="flex-parent-container">
    <!-- Sidebar -->
    <div class="flex-left-container">
        <h3>File Tree</h3>
        <div class="outer">
            <ul id="fileTree">
                <!-- Dynamic file tree content will be inserted here -->
            </ul>
        </div>
    </div>
    
    <!-- Main Content Section -->
    <div class="flex-right-container">
        <div class="table-frame">
            <div class="button-container">
                <button class="add-chart-btn">ADD ACCOUNT</button>
            </div>
            <table class="table-acc">
                <thead>
                    <tr>
                        <th>Account Code</th>
                        <th>Account Description</th>
                        <th>Account Type</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Dynamic rows will be inserted here -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Add Account Modal -->
<div id="addChartModal" class="modal">
    <div class="modal-content">
        <span class="close-btn">&times;</span>
        <h2>Add New Account</h2>
        <form id="addChartForm" class="form-grid">
            <label for="AccountCode">Account Code:</label>
            <input type="text" name="AccountCode" class="input" required />
            <label for="AccountDesc">Account Description:</label>
            <input type="text" name="AccountDesc" class="input" required />
            <label for="AccountType">Account Type:</label>
            <select class="accountType" name="AccountType" class="select" required>
                <option value="">Select Account Type</option>
            </select>
            <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
            <button type="submit" class="submit-btn">ADD ACCOUNT</button>
        </form>
    </div>
</div>

<!-- Edit Account Modal -->
<div id="editChartModal" class="modal">
    <div class="modal-content">
        <span class="close-btn">&times;</span>
        <h2>Edit Account</h2>
        <form id="editChartForm" class="form-grid">
            <label for="EditAccountCode">Account Code:</label>
            <input type="text" id="EditAccountCode" name="AccountCode" required />
            <label for="EditAccountDesc">Account Description:</label>
            <input type="text" id="EditAccountDesc" name="AccountDesc" required />
            <label for="EditAccountType">Account Type:</label>
            <select id="EditAccountType" class="accountType" name="AccountType" required>
                <option value="">Select Account Type</option>
            </select>
            <input type="hidden" id="EditAccountId" name="id" />
            <button type="submit" class="submit-btn">SAVE CHANGES</button>
        </form>
    </div>
</div>

{% endblock %} 

{% block extra_js %}
<script src="{% static 'js/chartofacc.js' %}"></script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const fileTree = document.getElementById('fileTree');
        // Fetch and populate the file tree with account data
        function loadFileTree() {
            fetch('/get-account-types/', {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'Content-Type': 'application/json',
                },
            })
            .then((response) => {
                if (!response.ok) {
                    throw new Error('Failed to load file tree data');
                }
                return response.json();
            })
            .then((data) => {
                console.log('Fetched data:', data); // Inspect the API response
                const fileTree = document.getElementById('fileTree');
                fileTree.innerHTML = ''; // Clear existing tree content

                // Create the root node
                const rootNode = document.createElement('li');
                rootNode.innerHTML = `<span class="caret">List of Accounts</span>`;
                const rootNested = document.createElement('ul');
                rootNested.classList.add('nested');

                // Populate accounts grouped by AccountName
                data.forEach((category) => {
                    if (category.AccountName && Array.isArray(category.Accounts)) {
                        const categoryNode = document.createElement('li');
                        categoryNode.innerHTML = `<span class="caret">${category.AccountName}</span>`;
                        const categoryNested = document.createElement('ul');
                        categoryNested.classList.add('nested');

                        // Add accounts under each category
                        category.Accounts.forEach((account) => {
                            const accountNode = document.createElement('li');
                            accountNode.innerHTML = `<span>${account.AccountCode} - ${account.AccountDesc}</span>`;
                            accountNode.classList.add('account-item');
                            accountNode.dataset.accountId = account.id; // Optional: Use data attributes for future actions
                            categoryNested.appendChild(accountNode);
                        });

                        categoryNode.appendChild(categoryNested);
                        rootNested.appendChild(categoryNode);
                    } else {
                        console.warn('Category has no accounts or is malformed:', category);
                    }
                });

                rootNode.appendChild(rootNested);
                fileTree.appendChild(rootNode);

                // Add toggle functionality
                addToggleFunctionality();
            })
            .catch((error) => console.error('Error loading file tree:', error));
        }

        // Add toggle functionality to the file tree
        function addToggleFunctionality() {
            const toggler = document.getElementsByClassName('caret');
            for (let i = 0; i < toggler.length; i++) {
                toggler[i].addEventListener('click', function () {
                    const nestedList = this.parentElement.querySelector('.nested');
                    if (nestedList) {
                        nestedList.classList.toggle('active');
                        this.classList.toggle('caret-down');
                    }
                });
            }
        }

        // Optional: Add click event to handle account clicks
        function handleAccountClick(event) {
            const accountId = event.target.dataset.accountId;
            if (accountId) {
                console.log('Account clicked:', accountId);
                // You can use this to display details, load data, etc.
                alert(`Account Selected: ${accountId}`);
            }
        }

        // Call the function to load the file tree on page load
        loadFileTree();

        // Add a global event listener for account clicks
        const fileTreeContainer = document.getElementById('fileTree');
        if (fileTreeContainer) {
            fileTreeContainer.addEventListener('click', event => {
                if (event.target && event.target.classList.contains('account-item')) {
                    handleAccountClick(event);
                }
            });
        }
    });
</script>


{% endblock %}